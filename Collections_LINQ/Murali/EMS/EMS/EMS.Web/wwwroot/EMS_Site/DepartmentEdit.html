

    <!-- Refactored Inline Script -->
    <script>
        (function () {
            'use strict';

            /* ---------------- Helper Functions ---------------- */
            const qs = (s) => document.querySelector(s);
            const getParam = (name) =>
                new URLSearchParams(window.location.search).get(name);
            const alertMsg = (msg) => alert(msg);

            const STORAGE_KEY = "ems_departments_v1";

            /* -------- LocalStorage fallback if DepartmentApp not provided -------- */
            const LocalApp = {
                load() {
                    try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || []; }
                    catch { return []; }
                },
                save(list) {
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
                },

                addDepartment(payload) {
                    const list = this.load();

                    const nextId = list.length
                        ? Math.max(...list.map(d => d.DepartmentIdPk)) + 1
                        : 1;

                    const maxCode = Math.max(
                        0,
                        ...list
                            .map(d => d.DepartmentCode)
                            .map(code => parseInt(code?.split("-")[1]) || 0)
                    );

                    const newDept = {
                        DepartmentIdPk: nextId,
                        DepartmentCode: "D-" + String(maxCode + 1).padStart(3, "0"),
                        DepartmentName: payload.DepartmentName,
                        Location: payload.Location,
                        IsActive: !!payload.IsActive
                    };

                    list.push(newDept);
                    this.save(list);
                    return newDept;
                },

                updateDepartment(id, updates) {
                    const list = this.load();
                    const index = list.findIndex(d => d.DepartmentIdPk === id);
                    if (index === -1) return null;
                    list[index] = { ...list[index], ...updates };
                    this.save(list);
                    return list[index];
                },

                getDepartmentById(id) {
                    return this.load().find(d => d.DepartmentIdPk === id) || null;
                }
            };

            const App = window.DepartmentApp || LocalApp;

            /* ---------------- DOM Elements ---------------- */
            const form = qs("#deptForm");
            const idField = qs("#editingId");
            const nameField = qs("#deptName");
            const locationField = qs("#deptLocation");
            const isActiveCheck = qs("#deptIsActive");
            const isActiveContainer = qs("#isActiveContainer");

            const pageTitle = qs("#pageTitle");
            const cardTitle = qs("#cardTitle");
            const cardHelp = qs("#cardHelp");

            /* ---------------- Determine Mode ---------------- */
            const deptIdParam = getParam("id");
            const isEdit = !!deptIdParam;

            /* ---------------- Init Page ---------------- */
            function initPage() {
                if (isEdit) loadEditMode();
                else loadAddMode();

                form.addEventListener("submit", handleSubmit);
            }

            function loadAddMode() {
                pageTitle.textContent =
                    cardTitle.textContent =
                    cardHelp.textContent =
                    "Add Department";

                isActiveContainer.style.display = "none";
                isActiveCheck.checked = true;
            }

            function loadEditMode() {
                pageTitle.textContent = "Edit Department";
                cardTitle.textContent = "Edit Department";
                cardHelp.textContent = "Modify department details.";

                isActiveContainer.style.display = "";

                const id = parseInt(deptIdParam, 10);
                const dept = App.getDepartmentById(id);

                if (!dept) {
                    alertMsg("Department not found.");
                    returnToList();
                    return;
                }

                idField.value = dept.DepartmentIdPk;
                nameField.value = dept.DepartmentName;
                locationField.value = dept.Location;
                isActiveCheck.checked = dept.IsActive;
            }

            /* ---------------- Submit Handler ---------------- */
            function handleSubmit(e) {
                e.preventDefault();

                const name = nameField.value.trim();
                const location = locationField.value.trim();

                if (!name || !location) {
                    alertMsg("Please fill Department Name and Location.");
                    return;
                }

                if (isEdit) updateDepartment();
                else addDepartment();
            }

            /* ---------------- CRUD Operations ---------------- */
            function addDepartment() {
                const newDept = App.addDepartment({
                    DepartmentName: nameField.value.trim(),
                    Location: locationField.value.trim(),
                    IsActive: true
                });

                if (!newDept) {
                    alertMsg("Failed to add department.");
                    return;
                }

                returnToList();
            }

            function updateDepartment() {
                const id = parseInt(idField.value, 10);

                const updated = App.updateDepartment(id, {
                    DepartmentName: nameField.value.trim(),
                    Location: locationField.value.trim(),
                    IsActive: isActiveCheck.checked
                });

                if (!updated) {
                    alertMsg("Failed to update department.");
                    return;
                }



                returnToList();
            }

            /* ---------------- Navigation ---------------- */
            function returnToList() {
                window.location.href = "/EMS_Site/DepartmentsList.html";
            }

            /* ---------------- Start ---------------- */
            initPage();

        })();
    </script>

</body>
</html>
