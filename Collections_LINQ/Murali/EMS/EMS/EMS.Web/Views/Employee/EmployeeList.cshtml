@model List<EMS.Web.Models.EmployeeListViewModel>

@*
    For more information on enabling MVC for empty projects, visit https://go.microsoft.com/fwlink/?LinkID=397860
*@
@{

	int counter = 0;

}

<main id="main-content" class="flex-fill">
	<div class="container-fluid pt-5 mt-3">

		<div class="d-flex justify-content-between align-items-center mb-3">
			<h2 class="h3"><i class="fas fa-users me-2"></i> Employee List</h2>
			<div>
				<a id="btnAddEmployee" class="btn btn-success" asp-controller="Employee" asp-action="AddEmployee">
					Add Employee
				</a>
			</div>
		</div>

		<!-- Filters / Search area (matches sketch) -->
		<div class="card mb-3">
			<div class="card-body">
				<form id="filterForm" class="row gy-2 gx-2 align-items-end">
					<div class="col-md-4">
						<label class="form-label small text-muted">Search by Name</label>
						<div class="input-group">
							<span class="input-group-text bg-white"><i class="fas fa-search"></i></span>
							<input id="filterName" type="text" class="form-control" placeholder="Search by first or last name..." />
						</div>
					</div>

					<div class="col-md-3">
						<label class="form-label small text-muted">Gender</label>
						<select id="filterGender" class="form-select">
							<option value="">All</option>
							<option value="Male">Male</option>
							<option value="Female">Female</option>
							<option value="Other">Other</option>
						</select>
					</div>

					<div class="col-md-3">
						<label class="form-label small text-muted">Designation / Group</label>
						<select id="filterDesignation" class="form-select">
							<option value="">All</option>
							<option value="IT">IT</option>
							<option value="Finance">Finance</option>
							<option value="HR">HR</option>
							<option value="Marketing">Marketing</option>
							<option value="Sales">Sales</option>
						</select>
					</div>

					<div class="col-md-2 d-flex gap-2">
						<button type="button" id="btnSearch" class="btn btn-primary w-100">Search</button>
						<button type="reset" id="btnClear" class="btn btn-outline-secondary w-100">Clear</button>
					</div>
				</form>
			</div>
		</div>

		<!-- Data Grid -->
		<div class="card shadow-sm">
			<div class="card-body p-0">
				<div class="table-responsive">
					<table class="table table-hover table-striped mb-0 align-middle" id="employeeTable" aria-describedby="employeeTableCaption">
						<caption id="employeeTableCaption" class="visually-hidden">Employee grid: S.NO, Code, First Name, Last Name, Group, Gender, Mobile, Actions</caption>
						<thead class="table-light">
							<tr>
								<th scope="col">S.NO</th>
								<th scope="col">EmpCode</th>
								<th scope="col">Name</th>
								<th scope="col">Mobile No</th>
								<th scope="col">Gender</th>
								<th scope="col">Email</th>
								<th scope="col">Is Active</th>
								<th scope="col">Actions</th>
							</tr>
						</thead>
						<tbody id="employeeTbody">

							@{
								if (Model.Count < 1)
								{
									<tr>
										<td colspan="13" class="text-center">No employee(s) found.</td>
									</tr>
								}
								else
								{
									foreach (var emp in Model)
									{
										<tr>
											<td>@(++counter)</td>
											<td>@emp.EmployeeId</td>
											<td>@emp.Code</td>
											<td>@emp.FirstName @emp.LastName</td>
											<td>@emp.MobileNumber</td>
											<td>@emp.Gender</td>
											<td>@emp.EmailId</td>
											<td>@(emp.IsActive ? "Yes" : "No")</td>
											<td class="text-center">
												<a class="btn btn-primary btn-sm me-1"
												   asp-controller="Employee"
												   asp-action="ViewEmployee"
												   asp-route-id="@emp.EmployeeId">
													View
												</a>

												<a class="btn btn-warning btn-sm me-1"
												   asp-controller="Employee"
												   asp-action="EditEmployee"
												   asp-route-id="@emp.EmployeeId">
													Edit
												</a>


												@if (emp.IsActive)
												{
													<button class="btn btn-danger btn-sm"
															onclick="deleteEmployee(@emp.EmployeeId, '@(emp.FirstName)')">
														Deactivate
													</button>
												}
												else
												{
													<button class="btn btn-success btn-sm"
															onclick="activateEmployee(@emp.EmployeeId, '@(emp.FirstName)')">
														Activate
													</button>
												}

											</td>
										</tr>
									}
								}
							}
						</tbody>
					</table>
				</div>
			</div>
		</div>
	</div>
</main>
<script src="~/lib/jquery/dist/jquery.min.js"></script>
<script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
<script src="~/js/employee/employee-list.js"></script>
<script type="text/javascript">
	 function goToAdd(){

		 location.href=  '@Url.Action("CreateEmployee", "Employee")';
	 }
	 /*function goToEdit(id){
		 location.href=  '@Url.Action("EditEmployee", "Employee")' + '/'+ id;
	 }

	 function goToView(id){
		 location.href=  '@Url.Action("ViewEmployee", "Employee")' + '/'+ id;
	 }*/
	 function deleteEmployee(id,firstName){
			 var confirmResult  = confirm('Are you sure you want to delete '+ firstName + ' employee?')
			 if(!confirmResult){
				 return;
			 }

			 const myHeaders = new Headers();
			 myHeaders.append("Content-Type", "application/json");

			 const myRequest = new Request('@Url.Action("delete", "Employee")', {
			   method: "POST",
			   body: JSON.stringify({ employeeId: id }),
			   headers: myHeaders,
			 });

			 debugger;

			 fetch(myRequest)
					 .then(response =>{
						 debugger;
						 console.log(response)
						 return response.json()
					 })
					 .then(data =>{
						 debugger;

						 if(data.success){
							 location.href='';
							 //success
						 }else{
							 alert(data.message);
							 //failed
						 }

						 console.log(data)
						 })
					 .catch(error =>{
						 debugger;
						 console.error('Error:', error)
					 });
					 return;
					  ///////////////////////OLD code//////////////////////
					   fetch('@Url.Action("delete", "Employee")/' +id)
					  .then(response =>{
						  debugger;
						  console.log(response)
					  return response.json()
					  })
					  .then(data =>{
						  debugger;

						  if(data.success){
							  location.href='';
							  //success
						  }else{
							  alert(data.message);
							  //failed
						  }

						  console.log(data)
					  })
					  .catch(error =>{
						  debugger;
						  console.error('Error:', error)
					  });


	}
	//////////////////old code///////////////////////////////////
	 function activateEmployee(id, employeeName){
			   var confirmResult  = confirm('Are you sure you want to activate '+ employeeName + ' ?')
			  if(!confirmResult){
				  return;
			  }
			  fetch('@Url.Action("active", "Employee")' + '/'+ id)
					  .then(response =>{
						  debugger;
						  console.log(response)
						  return response.json()
					  })
					  .then(data =>{
					  debugger;

						  if(data.success){
							  location.href='';
							  //success
						  }else{
							  alert(data.message);
							  //failed
						  }

					  console.log(data)
					  })
					  .catch(error =>{
						  debugger;
						  console.error('Error:', error)
					  });

	 }


	   let table = new DataTable('#empTable');


</script>

