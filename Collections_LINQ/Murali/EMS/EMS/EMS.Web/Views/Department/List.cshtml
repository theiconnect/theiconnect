   @model List<EMS.Web.Models.DepartmentViewModel>

@{
	ViewData["Title"] = "List";
	Layout = "~/Views/Shared/_EMSLayout.cshtml";
	int counter = 0;
	var msg = ViewBag.SuccessMessage;
}
@if (!string.IsNullOrEmpty(msg))
{
	<script>
		alert('@msg');
	</script>
}
<section class="mb-4">
	<div class="card">
		<div class="card-body">
			<!-- Search row -->
			<form asp-action="Searching" asp-controller="Department" method="get">
				<div class="row g-3 align-items-end">
					<div class="col-md-5">
						<label for="searchName" class="form-label">Name</label>
						<input id="searchName" name="searchName" type="text" class="form-control" placeholder="Search by department name">
					</div>
					<div class="col-md-5">
						<label for="searchLocation" class="form-label">Location</label>
						<input id="searchLocation" name="searchLocation" type="text" class="form-control" placeholder="Search by location">
					</div>
					<div class="col-md-2 d-flex gap-2">
						<button id="btnSearch" class="btn btn-primary" type="submit">Search</button>
					</div>
				</div>
			</form>
			<div class="mt-3">
				<button id="btnAddDept" class="btn btn-success" onclick="goToAdd()">Add Department</button>
			</div>
		</div>
	</div>
</section>

<!-- Grid / Table -->
<section>
	<div class="card">
		<div class="card-body">
			<div class="table-responsive">
				<table id="deptTable">
					<thead class="table-light">
						<tr>
							<th>Sno</th>
							<th>Code</th>
							<th>Name</th>
							<th>Location</th>
							<th>Active</th>
							<th>Actions</th>
						</tr>
					</thead>
					<tbody>
						@if (Model.Count < 1)
						{
							<tr>
								<td colspan="6" class="text-center">No department(s) found.</td>
							</tr>
						}
						else
						{
							@foreach (var dept in Model)
							{
								<tr>
									<td style='background-color:@(!dept.IsActive ? "red!important" : "")'>@(++counter) </td>
									<td style='background-color:@(!dept.IsActive ? "red!important" : "")'>
										<a title="click on this link to view details of @dept.DeptName department"
										   asp-route-id="@dept.DepartmentId"
										   asp-controller="Department"
										   asp-action="ViewDepartment"> @dept.Code </a>
									</td>
									<td style='background-color:@(!dept.IsActive ? "red!important" : "")'> @dept.DeptName </td>
									<td style='background-color:@(!dept.IsActive ? "red!important" : "")'>@dept.Location </td>
									<td style='background-color:@(!dept.IsActive ? "red!important" : "")'>@(dept.IsActive ? "Yes" : "No") </td>
									<td style='background-color:@(!dept.IsActive ? "red!important" : "")'>

										@Html.ActionLink("View", "View", "Department", new { @id = dept.DepartmentId }, new { @class = "btn btn-info" })
										@Html.ActionLink("Edit", "EditDepartment", "Department", new { @id = dept.DepartmentId }, new { @class = "btn btn-info" })

										@if (dept.IsActive)
										{
											<button class="btn btn-danger"
													onclick="deleteDepartment(@dept.DepartmentId, '@(dept.DeptName)');">
												Deactivate
											</button>
										}
										else
										{
											<button class="btn btn-success"
													onclick="activateDepartment(@dept.DepartmentId, '@(dept.DeptName)');">
												Activate
											</button>
										}
									</td>
								</tr>
							}
						}

					</tbody>
				</table>
			</div>
		</div>
		<div class="card-footer text-muted small">
			Showing departments.Use Search to filter results.
		</div>
	</div>
</section>

<script src="~/lib/jquery/dist/jquery.min.js"></script>
<script src="https://cdn.datatables.net/2.3.5/js/dataTables.min.js"></script>
<link href="https://cdn.datatables.net/2.3.5/css/dataTables.dataTables.min.css" />

@* <script type="text/javascript" src="cdn.datatables.net"></script> *@
<script type="text/javascript">
		function goToAdd(){
			//location.href = '/dept/new';
			//location.href = 'new';
			location.href=  '@Url.Action("CreateDepartment", "Department")';
		}

		/*function goToEdit(id){
			location.href=  '@Url.Action("EditDepartment", "Department")' + '/'+ id;
		}

		function goToView(id){
			location.href=  '@Url.Action("ViewDepartment", "Department")' + '/'+ id;
		}*/

		//Calling Delete endpoint using AJAX
		//AJAX - posting the data to the server with out refreshing the page content.
		function deleteDepartment(id, departmentName){
			var confirmResult  = confirm('Are you sure you want to delete '+ departmentName + ' department?')
			if(!confirmResult){
				return;
			}

			const myHeaders = new Headers();
			myHeaders.append("Content-Type", "application/json");

			const myRequest = new Request('@Url.Action("delete", "Department")', {
			  method: "POST",
			  body: JSON.stringify({ id: id, code : "code1", name: "name1", active:false }),
			  headers: myHeaders,
			});

			debugger;

			fetch(myRequest)
					.then(response =>{
						debugger;
						console.log(response)
						return response.json()
					})
					.then(data =>{
						debugger;

						if(data.success){
							location.href='';
							//success
						}else{
							alert(data.message);
							//failed
						}

						console.log(data)
					})
					.catch(error =>{
						debugger;
						console.error('Error:', error)
					});


					return;
	///////////////////////OLD code//////////////////////

			fetch('@Url.Action("delete", "Department")/' +id)
					.then(response =>{
						debugger;
						console.log(response)
						return response.json()
					})
					.then(data =>{
						debugger;

						if(data.success){
							location.href='';
							//success
						}else{
							alert(data.message);
							//failed
						}

						console.log(data)
					})
					.catch(error =>{
						debugger;
						console.error('Error:', error)
					});
		///////////////////////OLD code//////////////////////


		}

		function activateDepartment(id, departmentName){
			var confirmResult  = confirm('Are you sure you want to activate '+ departmentName + ' department?')
			if(!confirmResult){
				return;
			}
			fetch('@Url.Action("active", "Department")' + '/'+ id)
					.then(response =>{
						debugger;
						console.log(response)
						return response.json()
					})
					.then(data =>{
						debugger;

						if(data.success){
							location.href='';
							//success
						}else{
							alert(data.message);
							//failed
						}

						console.log(data)
					})
					.catch(error =>{
						debugger;
						console.error('Error:', error)
					});

		}


		 let table = new DataTable('#deptTable');

</script>